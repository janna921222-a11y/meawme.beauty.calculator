<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç¹†ç±³ç¾å­¸ | ç¾ç”²æ¬¾å¼è¨ˆç®—æ©Ÿ</title>

    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --cream-bg: #fdfaf5;
            --cream-card: #ffffff;
            --forest: #2d4639;
            --soft-gold: #b5a489;
            --soft-gray: #f5f2ee;
        }
        body { 
            background-color: var(--cream-bg); 
            color: var(--forest); 
            font-family: 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent; 
        }

        .app-container { max-width: 420px; margin: 0 auto; padding: 12px; }

        .k-card { 
            background: var(--cream-card); 
            border-radius: 24px; 
            box-shadow: 0 4px 10px rgba(45, 70, 57, 0.03); 
            border: 1px solid rgba(181, 164, 137, 0.1);
        }
        
        .k-input { 
            background: var(--soft-gray); 
            border-radius: 20px; 
            border: 1px solid transparent;
            padding: 4px 10px; 
            width: 100%; 
            font-size: 12px !important; 
        }
        .k-input:focus { outline: none; border-color: var(--soft-gold); background: white; }
        
        .k-input-readonly { 
            background: transparent; border: none; padding: 4px 0; width: 40px; text-align: center;
            font-size: 10px !important; font-weight: 700; color: var(--soft-gold);
        }

        .label-group { margin-left: 12px; margin-bottom: 2px; display: block; }
        .label-zh { font-weight: 700; font-size: 11px; color: var(--soft-gold); letter-spacing: 0.05em; }
        .label-en { font-weight: 400; font-size: 7px; color: var(--soft-gold); opacity: 0.4; text-transform: uppercase; }

        .tab-active { background-color: var(--forest) !important; color: white !important; }
        
        .option-btn { 
            background-color: var(--soft-gray); 
            color: var(--forest); 
            border-radius: 20px; 
            padding: 5px 8px; 
            font-size: 11px; 
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            border: 1px solid transparent;
        }
        .option-btn.active { background-color: var(--forest) !important; color: white !important; }
        
        .addon-card {
            background-color: var(--soft-gray);
            border-radius: 18px;
            padding: 8px 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            cursor: pointer;
            border: 1.5px solid transparent;
        }
        .addon-card.selected { background-color: var(--forest); color: white !important; }
        .addon-card.selected .addon-price { color: rgba(255,255,255,0.7); }
        .addon-name { font-size: 9px; font-weight: 700; margin-bottom: 1px; }
        .addon-price { font-size: 8px; font-weight: 500; color: var(--soft-gold); }

        .price-tag { font-size: 8px; opacity: 0.7; margin-top: 1px; display: none; }
        .active .price-tag { display: block; }

        .sticky-footer { 
            position: fixed; bottom: 12px; left: 12px; right: 12px; 
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px);
            border-radius: 25px; box-shadow: 0 8px 20px rgba(0,0,0,0.08); 
            z-index: 1000; padding: 10px 18px; max-width: 396px; margin: 0 auto;
        }

        .design-btn-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }
        .design-row { display: grid; grid-template-columns: 1fr 55px 70px 20px; align-items: center; gap: 5px; padding: 4px 0; }

        .stepper-btn {
            width: 20px; height: 20px; border-radius: 50%;
            background: var(--soft-gold); color: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: bold;
        }
        
        .footer-btn { background-color: var(--soft-gray); color: var(--forest); border-radius: 20px; font-weight: 700; font-size: 11px; transition: 0.2s; }
        #copyBtn { background-color: var(--forest); color: white; }

        /* å´é¸å–®/å½ˆçª—æ¨£å¼ */
        .sheet { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: white; border-top-left-radius: 30px; border-top-right-radius: 30px;
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); z-index: 2000; 
            max-height: 85vh; overflow-y: auto; padding: 25px;
        }
        .sheet.active { transform: translateY(0); }
        .overlay { display: none; position: fixed; inset: 0; background: rgba(45, 70, 57, 0.2); backdrop-filter: blur(3px); z-index: 1500; }
        .overlay.active { display: block; }

        /* å¾Œå°ç®¡ç†ç‰¹æœ‰æ¨£å¼ */
        .admin-section { border-bottom: 1px solid #f0f0f0; padding-bottom: 15px; margin-bottom: 15px; }
        .admin-label { font-size: 12px; font-weight: bold; color: var(--forest); margin-bottom: 8px; display: block; }
        .admin-row { display: flex; gap: 5px; margin-bottom: 5px; }
    </style>
</head>
<body class="pb-32"> 
    <div class="app-container">
        <header class="relative text-center pt-2 mb-3">
            <button onclick="toggleAdmin(true)" class="absolute right-0 top-0 p-2 text-gray-300 hover:text-soft-gold transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.17.31a1.464 1.464 0 0 1-.872 2.105l-.34.1c-1.413.413-1.413 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.699 1.283.705 2.686 1.987 1.987l.31-.17a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.413 2.397 1.413 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.17-.31a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.413-.413 1.413-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.699-1.283-.705-2.686-1.987-1.987l-.31.17a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.858 2.929 2.929 0 0 1 0 5.858z"/>
                </svg>
            </button>
            <div class="w-full flex items-center justify-center mb-1">
                <img src="logo.png" alt="" class="max-h-12 w-auto object-contain" onerror="this.style.display='none'">
            </div>
            <div> 
                <h1 class="text-sm font-bold tracking-[0.2em] text-forest">ç¾ç”²æ¬¾å¼è¨ˆç®—æ©Ÿ</h1>
                <p class="text-[7px] text-soft-gold tracking-widest leading-none">M E A W   M E   B E A U T Y</p>
            </div>
        </header>

        <div class="flex bg-white rounded-full p-1 mb-4 shadow-sm border border-gray-100">
            <button id="tab-regular" onclick="switchMode('regular')" class="flex-1 py-1.5 text-[10px] rounded-full transition-all tab-active font-bold">ä¸€èˆ¬é¡§å®¢</button>
            <button id="tab-model" onclick="switchMode('model')" class="flex-1 py-1.5 text-[10px] rounded-full transition-all text-gray-400 font-bold">æ‰‹æ¨¡å°ˆå€</button>
        </div>

        <div class="space-y-4">
            <section>
                <label class="label-group"><span class="label-zh">æ¬¾å¼åº•åƒ¹</span> <span class="label-en">Base</span></label>
                <div class="k-card p-2">
                    <div id="basePriceOptions" class="grid grid-cols-2 gap-2"></div>
                </div>
            </section>

            <section>
                <label class="label-group"><span class="label-zh">é€ å‹åŠ åƒ¹</span> <span class="label-en">Design</span></label>
                <div class="k-card p-2.5">
                    <div id="designSelectionGrid" class="design-btn-grid mb-2.5"></div>
                    <div id="designList" class="space-y-1"></div>
                </div>
            </section>

            <section id="section-addons">
                <label class="label-group"><span class="label-zh">å›ºå®šåŠ è³¼</span> <span class="label-en">Add-ons</span></label>
                <div class="k-card p-2.5 grid grid-cols-3 gap-2" id="addOnsList"></div>
            </section>

            <section>
                <label class="label-group"><span class="label-zh">å¸ç”²æœå‹™</span> <span class="label-en">Removal</span></label>
                <div class="k-card p-3">
                    <div class="flex gap-1.5 mb-3" id="removalButtons"></div>
                    <div id="specialRemovalList" class="space-y-2.5 border-t border-gray-50 pt-3"></div>
                </div>
            </section>

            <section>
                <label class="label-group"><span class="label-zh">é¡å¤–èª¿æ•´</span> <span class="label-en">Adj</span></label>
                <div class="k-card p-2.5">
                    <input type="number" id="adjAmount" class="k-input text-right font-bold" placeholder="è¼¸å…¥é‡‘é¡" oninput="calculate()">
                </div>
            </section>
        </div>
    </div>

    <footer class="sticky-footer flex items-center justify-between">
        <div class="flex flex-col">
            <p class="text-[7px] text-gray-400 uppercase font-bold tracking-tighter">Amount</p>
            <p class="text-lg font-bold text-forest leading-none">$<span id="totalDisplay">0</span></p>
        </div>
        <div class="flex gap-1">
            <button onclick="resetCalculator()" class="footer-btn px-2 py-2 text-gray-400 bg-transparent">æ¸…é™¤</button>
            <button onclick="toggleSheet('bottomSheet', true)" class="footer-btn px-3 py-2 bg-soft-gray">æ˜ç´°</button>
            <button id="copyBtn" onclick="copyBill()" class="footer-btn px-4 py-2">è¤‡è£½</button>
        </div>
    </footer>

    <div id="overlay" class="overlay" onclick="closeAllSheets()"></div>
    <div id="bottomSheet" class="sheet">
        <div class="max-w-[380px] mx-auto">
            <div class="w-10 h-1 bg-gray-100 rounded-full mx-auto mb-6"></div>
            <div id="billContent" class="space-y-2 text-xs"></div>
            <div class="mt-6 pt-4 border-t border-dashed border-gray-100 flex justify-between items-center">
                <span class="font-bold text-gray-300 text-[9px] uppercase tracking-widest">Total Payment</span>
                <span class="text-xl font-bold text-forest">$<span id="sheetTotal">0</span></span>
            </div>
            <button onclick="toggleSheet('bottomSheet', false)" class="w-full mt-8 py-3 footer-btn bg-soft-gray text-gray-500">Close</button>
        </div>
    </div>

    <div id="adminSheet" class="sheet">
        <div class="max-w-[380px] mx-auto pb-10">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-bold text-forest">å¾Œå°ç®¡ç†è¨­å®š</h2>
                <button onclick="toggleAdmin(false)" class="text-gray-400 text-xl">âœ•</button>
            </div>

            <div class="space-y-6">
                <div class="admin-section">
                    <h3 class="admin-label">ã€ä¸€èˆ¬é¡§å®¢ã€‘åº•åƒ¹è¨­å®š</h3>
                    <div id="admin-reg-base" class="space-y-2"></div>
                    <button onclick="addAdminItem('reg-base')" class="mt-2 text-[10px] text-soft-gold">+ æ–°å¢åº•åƒ¹é …ç›®</button>
                </div>

                <div class="admin-section">
                    <h3 class="admin-label">ã€æ‰‹æ¨¡å°ˆå€ã€‘åº•åƒ¹è¨­å®š</h3>
                    <div id="admin-model-base" class="space-y-2"></div>
                    <button onclick="addAdminItem('model-base')" class="mt-2 text-[10px] text-soft-gold">+ æ–°å¢åº•åƒ¹é …ç›®</button>
                </div>

                <div class="admin-section">
                    <h3 class="admin-label">é€ å‹åŠ åƒ¹é …ç›® (é€—é»éš”é–‹)</h3>
                    <textarea id="admin-design-items" class="k-input h-20 text-[11px] leading-relaxed" placeholder="è²“çœ¼,è·³è‰²,æ¼¸å±¤..."></textarea>
                </div>

                <button onclick="saveAdminSettings()" class="w-full py-4 bg-forest text-white rounded-2xl font-bold shadow-lg">å„²å­˜ä¸¦å¥—ç”¨è¨­å®š</button>
                <button onclick="resetToDefault()" class="w-full py-2 text-gray-300 text-[10px]">æ¢å¾©åˆå§‹é è¨­å€¼</button>
            </div>
        </div>
    </div>

    <script>
        // é è¨­åˆå§‹è³‡æ–™
        const defaultConfigs = {
            regular: {
                base: [{name: "å–®è‰²/è·³è‰²", price: 700},{name: "è²“çœ¼", price: 800}],
                designItems: ["è²“çœ¼", "è·³è‰²", "æ¼¸å±¤", "é¡é¢", "æšˆæŸ“", "æ³•å¼", "æ‰‹ç¹ª", "ç«‹é«”", "é‘½é£¾", "è²¼ç´™", "å»¶ç”²", "è£œç”²"],
                fixedAdd: [{name: "åŸºç¤ä¿é¤Š", price: 500},{name: "æ·±å±¤ä¿é¤Š", price: 800},{name: "å…¨å»¶ç”²", price: 500}],
                defaultDesignPrice: 25,
                removalOptions: [{n: "ç„¡", p: 0}, {n: "æœ¬åº—å¸ç”²", p: 200}, {n: "ä»–åº—å¸ç”²", p: 300}],
                specialRemoval: [{ id: 'bigDiamond', name: 'å¤§é‘½', defaultPrice: 20 }, { id: '3d', name: 'ç«‹é«”', defaultPrice: 20 }]
            },
            model: {
                base: [{name: "å–®è‰²/è·³è‰²", price: 399},{name: "è²“çœ¼", price: 499}],
                designItems: ["è²“çœ¼", "è·³è‰²", "æ¼¸å±¤", "é¡é¢", "æšˆæŸ“", "æ³•å¼", "æ‰‹ç¹ª", "ç«‹é«”", "é‘½é£¾", "è²¼ç´™", "å»¶ç”²", "è£œç”²"],
                fixedAdd: [],
                defaultDesignPrice: 15,
                removalOptions: [{n: "ç„¡", p: 0}, {n: "å¸ç”²", p: 100}],
                specialRemoval: [{ id: 'bigDiamond', name: 'å¤§é‘½', defaultPrice: 10 }, { id: '3d', name: 'ç«‹é«”', defaultPrice: 10 }, { id: 'ext', name: 'å»¶ç”²', defaultPrice: 10 }]
            }
        };

        let allConfigs = JSON.parse(localStorage.getItem('nail_calc_config')) || defaultConfigs;
        let currentMode = 'regular';
        let selectedBasePrice = 0, selectedBaseName = "", currentRemovalPrice = 0;

        function init() {
            const config = allConfigs[currentMode];
            
            // æ¸²æŸ“åº•åƒ¹
            document.getElementById('basePriceOptions').innerHTML = config.base.map((i, idx) => `
                <button onclick="setBasePrice(${i.price}, '${i.name}', this)" class="base-btn py-1.5 option-btn ${idx===0?'active':''}">
                    <div>${i.name}</div>
                    <div class="price-tag">$${i.price}</div>
                </button>
            `).join('');
            selectedBasePrice = config.base[0]?.price || 0;
            selectedBaseName = config.base[0]?.name || "";

            // æ¸²æŸ“é€ å‹åŠ åƒ¹æŒ‰éˆ•
            document.getElementById('designSelectionGrid').innerHTML = config.designItems.map(n => `
                <button onclick="addDesignItem('${n}')" class="py-1 option-btn text-[10px] font-bold !rounded-full">${n}</button>
            `).join('');
            
            // æ¸²æŸ“å¸ç”²æŒ‰éˆ•
            document.getElementById('removalButtons').innerHTML = config.removalOptions.map((opt, idx) => `
                <button onclick="setRemoval(${opt.p}, this)" class="removal-btn flex-1 py-1 option-btn ${idx===0?'active':''}">
                    <div class="leading-tight text-[10px]">${opt.n}</div>
                    <div class="removal-price">$${opt.p}</div>
                </button>
            `).join('');
            currentRemovalPrice = config.removalOptions[0].p;

            // æ¸²æŸ“å›ºå®šåŠ è³¼
            const addOnsList = document.getElementById('addOnsList');
            if (config.fixedAdd && config.fixedAdd.length > 0) {
                document.getElementById('section-addons').style.display = 'block';
                addOnsList.innerHTML = config.fixedAdd.map(i => `
                    <div onclick="toggleAddon(this)" class="addon-card">
                        <span class="addon-name">${i.name}</span>
                        <span class="addon-price">$${i.price}</span>
                    </div>`).join('');
            } else { document.getElementById('section-addons').style.display = 'none'; }

            // æ¸²æŸ“ç‰¹æ®Šå¸é™¤
            document.getElementById('specialRemovalList').innerHTML = config.specialRemoval.map(item => `
                <div class="flex justify-between items-center">
                    <span class="text-[10px] font-bold text-gray-400 min-w-[50px]">${item.name}</span>
                    <div class="flex items-center gap-3">
                        <div class="flex items-center">
                            <span class="text-[10px] text-soft-gold font-bold mr-1">$</span>
                            <input type="number" id="price_${item.id}" class="k-input-readonly" value="${item.defaultPrice}" readonly>
                        </div>
                        <div class="flex items-center gap-2.5 bg-gray-50 p-1 px-2.5 rounded-full border border-gray-100">
                            <button onclick="changeStep('val_${item.id}', -1)" class="stepper-btn">-</button>
                            <span id="val_${item.id}" class="font-bold text-[10px] w-4 text-center">0</span>
                            <button onclick="changeStep('val_${item.id}', 1)" class="stepper-btn">+</button>
                        </div>
                    </div>
                </div>`).join('');

            document.getElementById('designList').innerHTML = '';
            calculate();
        }

        /* --- ç®¡ç†å¾Œå°é‚è¼¯ --- */
        function toggleAdmin(show) {
            if(show) {
                // é–‹å•Ÿæ™‚å¡«å…¥ç•¶å‰è¨­å®š
                fillAdminPanel();
                toggleSheet('adminSheet', true);
            } else {
                toggleSheet('adminSheet', false);
            }
        }

        function fillAdminPanel() {
            const regBaseList = document.getElementById('admin-reg-base');
            const modBaseList = document.getElementById('admin-model-base');
            
            const renderRows = (data) => data.map((item, idx) => `
                <div class="admin-row">
                    <input type="text" class="k-input flex-1" value="${item.name}" placeholder="åç¨±">
                    <input type="number" class="k-input w-20" value="${item.price}" placeholder="åƒ¹æ ¼">
                    <button onclick="this.parentElement.remove()" class="text-red-300 px-1">âœ•</button>
                </div>
            `).join('');

            regBaseList.innerHTML = renderRows(allConfigs.regular.base);
            modBaseList.innerHTML = renderRows(allConfigs.model.base);
            document.getElementById('admin-design-items').value = allConfigs.regular.designItems.join(',');
        }

        function addAdminItem(type) {
            const container = document.getElementById(`admin-${type}`);
            container.insertAdjacentHTML('beforeend', `
                <div class="admin-row">
                    <input type="text" class="k-input flex-1" placeholder="åç¨±">
                    <input type="number" class="k-input w-20" placeholder="åƒ¹æ ¼">
                    <button onclick="this.parentElement.remove()" class="text-red-300 px-1">âœ•</button>
                </div>
            `);
        }

        function saveAdminSettings() {
            const getRows = (id) => {
                const rows = [];
                document.getElementById(id).querySelectorAll('.admin-row').forEach(row => {
                    const inputs = row.querySelectorAll('input');
                    if(inputs[0].value) rows.push({ name: inputs[0].value, price: parseInt(inputs[1].value) || 0 });
                });
                return rows;
            };

            allConfigs.regular.base = getRows('admin-reg-base');
            allConfigs.model.base = getRows('admin-model-base');
            
            const designs = document.getElementById('admin-design-items').value.split(',').map(s => s.trim()).filter(s => s);
            allConfigs.regular.designItems = designs;
            allConfigs.model.designItems = designs;

            localStorage.setItem('nail_calc_config', JSON.stringify(allConfigs));
            alert('è¨­å®šå„²å­˜æˆåŠŸï¼');
            toggleAdmin(false);
            init();
        }

        function resetToDefault() {
            if(confirm('ç¢ºå®šè¦æ¢å¾©é è¨­å€¼å—ï¼Ÿæ‰€æœ‰ä¿®æ”¹å°‡æœƒæ¶ˆå¤±ã€‚')) {
                localStorage.removeItem('nail_calc_config');
                allConfigs = JSON.parse(JSON.stringify(defaultConfigs));
                init();
                toggleAdmin(false);
            }
        }

        /* --- è¨ˆç®—æ©Ÿæ ¸å¿ƒé‚è¼¯ --- */
        function toggleAddon(el) { el.classList.toggle('selected'); calculate(); }

        function setBasePrice(p, n, btn) {
            selectedBasePrice = p; selectedBaseName = n;
            document.querySelectorAll('.base-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active'); calculate();
        }

        function addDesignItem(name) {
            const id = 'd_' + Date.now();
            const config = allConfigs[currentMode];
            const html = `
                <div id="${id}" class="design-row">
                    <span class="font-bold text-[10px] text-gray-500 truncate bg-soft-gray/30 px-2 py-0.5 rounded-full">${name}</span>
                    <input type="number" class="price-input k-input !py-0.5 !text-center !text-[9px] font-bold" value="${config.defaultDesignPrice}" oninput="calculate()">
                    <div class="flex items-center justify-between bg-soft-gray/50 rounded-full px-2 py-0.5">
                        <button onclick="changeQty('${id}', -1)" class="text-forest font-bold w-3 text-[10px]">-</button>
                        <span class="qty font-bold text-[10px] w-3 text-center">1</span>
                        <button onclick="changeQty('${id}', 1)" class="text-forest font-bold w-3 text-[10px]">+</button>
                    </div>
                    <button onclick="document.getElementById('${id}').remove();calculate()" class="text-gray-300 text-[10px]">âœ•</button>
                </div>`;
            document.getElementById('designList').insertAdjacentHTML('beforeend', html);
            calculate();
        }

        function changeQty(id, delta) {
            const el = document.querySelector(`#${id} .qty`);
            el.innerText = Math.max(1, parseInt(el.innerText) + delta);
            calculate();
        }

        function setRemoval(p, btn) {
            currentRemovalPrice = p;
            document.querySelectorAll('.removal-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active'); calculate();
        }

        function changeStep(id, delta) {
            const el = document.getElementById(id);
            if (el) { el.innerText = Math.max(0, parseInt(el.innerText) + delta); calculate(); }
        }

        function switchMode(mode) {
            currentMode = mode;
            const regBtn = document.getElementById('tab-regular');
            const modBtn = document.getElementById('tab-model');
            regBtn.className = `flex-1 py-1.5 text-[10px] rounded-full transition-all ${mode==='regular'?'tab-active font-bold':'text-gray-400 font-bold'}`;
            modBtn.className = `flex-1 py-1.5 text-[10px] rounded-full transition-all ${mode==='model'?'tab-active font-bold':'text-gray-400 font-bold'}`;
            init();
        }

        function calculate() {
            let total = 0, items = [];
            total += selectedBasePrice;
            items.push({ n: selectedBaseName, p: selectedBasePrice });

            document.querySelectorAll('#designList > div').forEach(row => {
                const name = row.querySelector('span').innerText;
                const qty = parseInt(row.querySelector('.qty').innerText);
                const up = parseInt(row.querySelector('.price-input').value) || 0;
                total += (qty * up);
                items.push({ n: `âœ¨ ${name} (${qty}æŒ‡)`, p: qty * up });
            });

            document.querySelectorAll('.addon-card.selected').forEach(card => {
                const name = card.querySelector('.addon-name').innerText;
                const price = parseInt(card.querySelector('.addon-price').innerText.replace('$', ''));
                total += price;
                items.push({ n: `â• ${name}`, p: price });
            });

            if(currentRemovalPrice > 0) { 
                const opt = allConfigs[currentMode].removalOptions.find(o => o.p === currentRemovalPrice);
                items.push({ n: `ğŸ§¼ ${opt.n}`, p: currentRemovalPrice });
                total += currentRemovalPrice;
            }

            allConfigs[currentMode].specialRemoval.forEach(item => {
                const count = parseInt(document.getElementById('val_' + item.id).innerText);
                const price = parseInt(document.getElementById('price_' + item.id).value) || 0;
                if (count > 0) { total += (count * price); items.push({ n: `ğŸ’ ${item.name}å¸é™¤ (${count}æŒ‡)`, p: count * price }); }
            });

            const adj = parseInt(document.getElementById('adjAmount').value) || 0;
            if(adj !== 0) { total += adj; items.push({ n: adj > 0 ? 'âš™ï¸ é¡å¤–åŠ åƒ¹' : 'ğŸ å„ªæƒ æŠ˜æ‰£', p: adj }); }

            document.getElementById('totalDisplay').innerText = total.toLocaleString();
            document.getElementById('sheetTotal').innerText = total.toLocaleString();
            document.getElementById('billContent').innerHTML = items.map(i => `
                <div class="flex justify-between border-b border-gray-50 py-2">
                    <span class="text-gray-500">${i.n}</span>
                    <b class="text-forest">$${i.p.toLocaleString()}</b>
                </div>`).join('');
        }

        function toggleSheet(id, s) {
            document.getElementById(id).classList.toggle('active', s);
            document.getElementById('overlay').classList.toggle('active', s);
        }

        function closeAllSheets() {
            document.querySelectorAll('.sheet').forEach(s => s.classList.remove('active'));
            document.getElementById('overlay').classList.remove('active');
        }

        function copyBill() {
            const mode = currentMode === 'regular' ? 'ä¸€èˆ¬é¡§å®¢' : 'æ‰‹æ¨¡å°ˆå€';
            const itemsText = Array.from(document.querySelectorAll('#billContent > div')).map(row => {
                return `${row.querySelector('span').innerText}ï¼š${row.querySelector('b').innerText}`;
            }).join('\n');
            const date = new Date().toLocaleDateString();
            const text = `ã€ ç¹†ç±³ç¾å­¸ ğ‘´ğ‘¬ğ‘¨ğ‘¾ ğ‘´ğ‘¬ ğ‘©ğ‘¬ğ‘¨ğ‘¼ğ‘»ğ’€ ã€‘\næœå‹™æ—¥æœŸï¼š${date}\næœå‹™é¡å‹ï¼š${mode}\n\nçµå¸³æ˜ç´°ï¼š\n------------------------\n${itemsText}\n------------------------\nç¸½è¨ˆé‡‘é¡ï¼š$${document.getElementById('totalDisplay').innerText}\n\næ„Ÿè¬æ‚¨çš„é ç´„ âœ¨`;
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.getElementById('copyBtn'); btn.innerText = "COPIED";
                setTimeout(() => btn.innerText = "è¤‡è£½", 2000);
            });
        }

        function resetCalculator() { if (confirm('è¦æ¸…é™¤å—ï¼Ÿ')) { document.getElementById('adjAmount').value = ''; init(); } }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>